<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web IDE</title>
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .monaco-editor {
            height: 100%;
            width: 100%;
        }
        
        /* Mobile optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            .sidebar {
                width: 200px;
            }
            .editor-container {
                width: calc(100% - 200px);
            }
        }
        
        /* VS Code-like scrollbar */
        ::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }
        
        ::-webkit-scrollbar-thumb {
            background-color: #424242;
            border: 3px solid transparent;
            border-radius: 7px;
            background-clip: padding-box;
        }
        
        ::-webkit-scrollbar-track {
            background-color: transparent;
        }
        
        /* Dark mode styles */
        .dark {
            color-scheme: dark;
        }
    </style>
</head>
<body class="h-full bg-[#1e1e1e] text-white overflow-hidden">
    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-[#1e1e1e]">
        <div class="bg-[#2d2d2d] p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-2xl font-bold mb-6 text-center">GitHub Web IDE</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">GitHub Username</label>
                    <input type="text" id="github-username" class="w-full px-3 py-2 bg-[#3c3c3c] rounded border border-[#4c4c4c] focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Repository Name</label>
                    <input type="text" id="repo-name" class="w-full px-3 py-2 bg-[#3c3c3c] rounded border border-[#4c4c4c] focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">GitHub Client ID</label>
                    <input type="text" id="client-id" class="w-full px-3 py-2 bg-[#3c3c3c] rounded border border-[#4c4c4c] focus:outline-none focus:border-blue-500">
                </div>
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                    Connect to GitHub
                </button>
            </div>
        </div>
    </div>

    <!-- Main IDE Interface -->
    <div id="ide" class="hidden h-full flex flex-col">
        <!-- Top Bar -->
        <div class="h-12 bg-[#2d2d2d] border-b border-[#1e1e1e] flex items-center px-4 justify-between">
            <div class="flex items-center space-x-4">
                <button id="menu-toggle" class="p-2 hover:bg-[#3c3c3c] rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <span id="current-file" class="text-sm opacity-75">No file selected</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="save-btn" class="hidden px-3 py-1 text-sm bg-blue-600 hover:bg-blue-700 rounded">
                    Save
                </button>
                <button id="preview-btn" class="hidden px-3 py-1 text-sm bg-green-600 hover:bg-green-700 rounded">
                    Preview
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex">
            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-[#252526] flex flex-col">
                <!-- File Explorer Header -->
                <div class="h-10 flex items-center justify-between px-4 bg-[#2d2d2d]">
                    <span class="text-sm font-medium">EXPLORER</span>
                    <button id="new-file-btn" class="p-1 hover:bg-[#3c3c3c] rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                </div>
                <!-- File Tree -->
                <div id="file-tree" class="flex-1 overflow-y-auto p-2">
                    <!-- Files will be populated here -->
                </div>
            </div>

            <!-- Editor Container -->
            <div class="flex-1 flex flex-col">
                <div id="editor" class="flex-1"></div>
                <div id="preview" class="hidden flex-1 bg-white">
                    <iframe id="preview-frame" class="w-full h-full"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            github: {
                apiUrl: 'https://api.github.com',
                clientId: null,
                token: null
            }
        };

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            window.editor = monaco.editor.create(document.getElementById('editor'), {
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                lineNumbers: 'on',
                scrollBeyondLastLine: false,
                renderWhitespace: 'selection',
                tabSize: 2
            });
        });

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const ide = document.getElementById('ide');
        const loginBtn = document.getElementById('login-btn');
        const githubUsername = document.getElementById('github-username');
        const repoName = document.getElementById('repo-name');
        const clientId = document.getElementById('client-id');
        const saveBtn = document.getElementById('save-btn');
        const previewBtn = document.getElementById('preview-btn');
        const fileTree = document.getElementById('file-tree');
        const preview = document.getElementById('preview');
        const previewFrame = document.getElementById('preview-frame');
        const currentFile = document.getElementById('current-file');
        const newFileBtn = document.getElementById('new-file-btn');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');

        // Event Listeners
        loginBtn.addEventListener('click', handleLogin);
        saveBtn.addEventListener('click', handleSave);
        previewBtn.addEventListener('click', togglePreview);
        newFileBtn.addEventListener('click', createNewFile);
        menuToggle.addEventListener('click', toggleSidebar);

        // GitHub API Integration
        const github = {
            clientId: '', // You'll need to set this when initializing the app
            
            // Initialize with your GitHub OAuth App client ID
            init(clientId) {
                this.clientId = clientId;
            },
            
            // Start OAuth flow
            authorize() {
                const params = new URLSearchParams({
                    client_id: this.clientId,
                    scope: 'repo',
                    redirect_uri: window.location.href
                });
                
                window.location.href = `https://github.com/login/oauth/authorize?${params}`;
            },
            
            // Get user info
            async getUser(token) {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                return response.json();
            },
            
            // Get repositories
            async getRepos(token) {
                const response = await fetch('https://api.github.com/user/repos?sort=updated&per_page=100', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                return response.json();
            },
            
            // Get repository contents
            async getContents(token, owner, repo, path = '', ref = 'main') {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}${ref ? '?ref=' + ref : ''}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                return response.json();
            },
            
            // Get file content
            async getFile(token, owner, repo, path, ref = 'main') {
                const content = await this.getContents(token, owner, repo, path, ref);
                if (Array.isArray(content)) {
                    throw new Error('Path is a directory');
                }
                return {
                    content: decodeURIComponent(escape(atob(content.content))),
                    sha: content.sha
                };
            },
            
            // Update file
            async updateFile(token, owner, repo, path, content, sha, message, branch = 'main') {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha,
                        branch
                    })
                });
                return response.json();
            }
        };

        // Update the login handler
        function handleLogin() {
            const clientId = document.getElementById('client-id').value;
            if (!clientId) {
                showToast('error', 'Please enter your GitHub Client ID');
                return;
            }
            
            // Initialize GitHub API with client ID
            github.init(clientId);
            
            // Store client ID for after redirect
            localStorage.setItem('github_client_id', clientId);
            
            // Start OAuth flow
            github.authorize();
        }

        // Handle OAuth callback
        async function handleOAuthCallback(code) {
            try {
                // Exchange code for token using GitHub's OAuth flow
                const token = await exchangeCodeForToken(code);
                if (!token) {
                    throw new Error('Failed to get access token');
                }
                
                // Store token
                localStorage.setItem('github_token', token);
                
                // Get user info
                const user = await github.getUser(token);
                updateUserInfo(user);
                
                // Get repositories
                const repos = await github.getRepos(token);
                populateRepoList(repos);
                
                // Show main interface
                showIDE();
                
                showToast('success', 'Successfully logged in!');
            } catch (error) {
                console.error('Auth error:', error);
                showToast('error', 'Authentication failed');
            }
        }

        // Exchange code for token using CORS proxy
        async function exchangeCodeForToken(code) {
            // Use a CORS proxy service to exchange the code for a token
            // Note: In production, you should use your own proxy or backend
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/https://github.com/login/oauth/access_token';
            const clientId = localStorage.getItem('github_client_id');
            
            const response = await fetch(proxyUrl, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: clientId,
                    code: code
                })
            });
            
            const data = await response.json();
            return data.access_token;
        }

        // Update file handling functions
        async function openFile(file) {
            try {
                const token = localStorage.getItem('github_token');
                const [owner, repo] = currentRepo.split('/');
                
                showToast('info', 'Loading file...');
                
                const { content, sha } = await github.getFile(token, owner, repo, file.path);
                
                // Update editor
                editor.setValue(content);
                currentFile = {
                    ...file,
                    content,
                    sha
                };
                
                // Update UI
                document.getElementById('file-name-input').value = file.name;
                document.getElementById('editor-container').classList.remove('hidden');
                document.getElementById('welcome-view').classList.add('hidden');
                
                isFileModified = false;
                
                showToast('success', 'File loaded successfully');
            } catch (error) {
                console.error('Error opening file:', error);
                showToast('error', 'Failed to load file');
            }
        }

        async function saveFile() {
            if (!currentFile) return;
            
            try {
                const token = localStorage.getItem('github_token');
                const [owner, repo] = currentRepo.split('/');
                const content = editor.getValue();
                const message = document.getElementById('commit-message').value || `Update ${currentFile.name}`;
                
                showToast('info', 'Saving changes...');
                
                const result = await github.updateFile(
                    token,
                    owner,
                    repo,
                    currentFile.path,
                    content,
                    currentFile.sha,
                    message,
                    currentBranch
                );
                
                // Update file info
                currentFile.sha = result.content.sha;
                currentFile.content = content;
                isFileModified = false;
                
                showToast('success', 'Changes saved successfully');
            } catch (error) {
                console.error('Error saving file:', error);
                showToast('error', 'Failed to save changes');
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Check for OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                // Remove code from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Handle OAuth callback
                handleOAuthCallback(code);
            }
            
            // Setup event listeners
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('save-btn').addEventListener('click', saveFile);
            
            // Setup editor change handler
            editor.on('change', () => {
                if (currentFile) {
                    isFileModified = true;
                }
            });
        });

        // File Operations
        async function loadRepositoryFiles(username, repo) {
            // In a real application, you would fetch files from GitHub API
            // For demo, we'll create some sample files
            const files = [
                { name: 'index.html', type: 'file', content: '<!DOCTYPE html><html><body><h1>Hello World</h1></body></html>' },
                { name: 'styles.css', type: 'file', content: 'body { color: blue; }' },
                { name: 'README.md', type: 'file', content: '# Project\nThis is a sample project.' }
            ];

            renderFileTree(files);
        }

        function renderFileTree(files) {
            fileTree.innerHTML = '';
            files.forEach(file => {
                const fileElement = createFileElement(file);
                fileTree.appendChild(fileElement);
            });
        }

        function createFileElement(file) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 p-1 hover:bg-[#2d2d2d] rounded cursor-pointer text-sm';
            
            const icon = document.createElement('span');
            icon.className = 'text-[#c5c5c5]';
            icon.textContent = file.type === 'file' ? '📄' : '📁';
            
            const name = document.createElement('span');
            name.textContent = file.name;
            
            div.appendChild(icon);
            div.appendChild(name);
            
            div.addEventListener('click', () => openFile(file));
            
            return div;
        }

        function openFile(file) {
            currentFile.textContent = file.name;
            window.editor.setValue(file.content);
            
            const isPreviewable = file.name.endsWith('.md') || file.name.endsWith('.html');
            previewBtn.classList.toggle('hidden', !isPreviewable);
            saveBtn.classList.remove('hidden');
            
            if (preview.classList.contains('flex')) {
                updatePreview();
            }
        }

        async function handleSave() {
            const content = window.editor.getValue();
            // In a real application, you would save to GitHub here
            alert('File saved successfully!');
        }

        function togglePreview() {
            const editorElement = document.getElementById('editor');
            preview.classList.toggle('hidden');
            preview.classList.toggle('flex');
            editorElement.classList.toggle('hidden');
            
            if (preview.classList.contains('flex')) {
                updatePreview();
            }
        }

        function updatePreview() {
            const content = window.editor.getValue();
            const fileName = currentFile.textContent;
            
            if (fileName.endsWith('.md')) {
                // For markdown, you would use a markdown parser here
                previewFrame.srcdoc = `<div style="padding: 20px;">${content}</div>`;
            } else if (fileName.endsWith('.html')) {
                previewFrame.srcdoc = content;
            }
        }

        function createNewFile() {
            const fileName = prompt('Enter file name:');
            if (fileName) {
                const file = { name: fileName, type: 'file', content: '' };
                const fileElement = createFileElement(file);
                fileTree.appendChild(fileElement);
                openFile(file);
            }
        }

        function toggleSidebar() {
            sidebar.classList.toggle('hidden');
        }

        // Mobile optimization
        function checkOrientation() {
            if (window.matchMedia("(max-width: 768px)").matches) {
                if (window.orientation === 0) {
                    alert('Please rotate your device to landscape mode for better experience');
                }
            }
        }

        window.addEventListener('load', checkOrientation);
        window.addEventListener('orientationchange', checkOrientation);
    </script>
</body>
</html>